<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luna AI - Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/adsgram-ad-sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#0f172a] text-white p-4 h-screen flex flex-col overflow-hidden">
    <div class="flex justify-between items-center border-b border-slate-700 pb-3 mb-4">
        <div>
            <h1 class="text-purple-400 font-bold text-xl">Luna AI Witch</h1>
            <p id="ad-count" class="text-[10px] text-slate-400">Iklan Hari Ini: 2/2</p>
        </div>
        <div class="flex flex-col items-end">
            <div id="energy-display" class="bg-slate-800 px-3 py-1 rounded-full text-yellow-400 text-xs font-bold border border-yellow-500/30">âš¡ -- Energy</div>
            <button onclick="bukaTopup()" class="text-[10px] bg-green-600 px-2 py-0.5 mt-1 rounded shadow-lg active:scale-90">âž• Topup Stars</button>
        </div>
    </div>

    <div id="chat-box" class="flex-1 overflow-y-auto space-y-4 mb-20 flex flex-col p-2 text-sm">
        <div class="bg-slate-800 p-3 rounded-lg self-start border border-slate-700 italic text-slate-400">"Ritual iklan terbatas 2x sehari. Butuh lebih? Gunakan Stars."</div>
    </div>

    <div id="ad-container" class="fixed bottom-24 left-4 right-4 hidden"><button onclick="panggilRitualIklan()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-black py-3 rounded-lg font-bold border-2 border-white uppercase">ðŸ“º Ritual Iklan (+5 Energy)</button></div>

    <div class="fixed bottom-6 left-4 right-4 flex gap-2">
        <input id="input-chat" type="text" placeholder="Bisikkan sesuatu..." class="flex-1 bg-slate-800 border border-slate-700 rounded-xl p-4 outline-none">
        <button onclick="kirimPesan()" class="bg-purple-600 px-6 rounded-xl font-bold shadow-lg">Kirim</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let energy = localStorage.getItem('luna_energy') !== null ? parseInt(localStorage.getItem('luna_energy')) : 10;
        let adData = JSON.parse(localStorage.getItem('luna_ads')) || { count: 0, lastDate: "" };
        const hariIni = new Date().toLocaleDateString();

        if (adData.lastDate !== hariIni) { adData = { count: 0, lastDate: hariIni }; localStorage.setItem('luna_ads', JSON.stringify(adData)); }
        const AdController = window.Adsgram.init({ blockId: "22974" });

        function sinkronkanUI() {
            document.getElementById('energy-display').innerText = `âš¡ ${energy} Energy`;
            document.getElementById('ad-count').innerText = `Iklan Hari Ini: ${2 - adData.count}/2`;
            localStorage.setItem('luna_energy', energy);
            const containerIklan = document.getElementById('ad-container');
            if (energy < 3 && adData.count < 2) containerIklan.classList.remove('hidden'); else containerIklan.classList.add('hidden');
        }

        async function panggilRitualIklan() {
            try {
                const result = await AdController.show();
                if (result.done) { energy += 5; adData.count += 1; localStorage.setItem('luna_ads', JSON.stringify(adData)); sinkronkanUI(); }
            } catch (e) { alert("Iklan belum siap (In Moderation)."); }
        }

        async function bukaTopup() {
            const confirmBuy = confirm("Beli 50 Energi seharga 10 Stars?");
            if (!confirmBuy) return;
            try {
                const response = await fetch("/api/create-stars-invoice", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId: tg.initDataUnsafe.user?.id || 0, starsAmount: 10, energyAmount: 50 })
                });
                const data = await response.json();
                if (data.invoiceLink) tg.openInvoice(data.invoiceLink, (status) => { if (status === 'paid') { energy += 50; sinkronkanUI(); alert("Berhasil!"); } });
            } catch (err) { alert("Gagal memproses pembayaran."); }
        }

        async function kirimPesan() {
            const input = document.getElementById('input-chat');
            const pesan = input.value.trim();
            if (!pesan || energy <= 0) return;
            input.value = ''; tambahBubble(pesan, 'user'); energy--; sinkronkanUI();
            try {
                const response = await fetch("/api/chat", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: pesan }) });
                const data = await response.json(); tambahBubble(data.reply, 'ai');
            } catch (err) { tambahBubble("Sihir terputus.", 'ai'); }
        }

        function tambahBubble(t, p) {
            const box = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.className = p === 'user' ? "bg-purple-600 p-3 rounded-lg self-end max-w-[85%] mb-2" : "bg-slate-800 p-3 rounded-lg self-start max-w-[85%] border border-slate-700 mb-2";
            d.innerText = t; box.appendChild(d); box.scrollTop = box.scrollHeight;
        }
        sinkronkanUI();
    </script>
</body>
</html>